
<div>auto-compl√©tion v1.00.07 intialized<br>press ctrl+space into script editor to use it</div>
<script src='https://codemirror.net/addon/hint/show-hint.js'></script>
<script>
    var style = `
    .CodeMirror-hints {
        position: absolute;
        z-index: 10;
        overflow: hidden;
        list-style: none;

        margin: 0;
        padding: 2px;

        -webkit-box-shadow: 2px 3px 5px rgba(0, 0, 0, .2);
        -moz-box-shadow: 2px 3px 5px rgba(0, 0, 0, .2);
        box-shadow: 2px 3px 5px rgba(0, 0, 0, .2);
        border-radius: 3px;
        border: 1px solid silver;

        background: white;
        font-size: 90%;

        max-height: 20em;
        overflow-y: auto;
    }

    .CodeMirror-hint {
        margin: 0;
        padding: 0 4px;
        border-radius: 2px;
        white-space: pre;
        color: black;
        cursor: pointer;
    }

    .CodeMirror-hint-active {
        background: #08f;
        color: white;
    }
    
    .CodeMirror-hint-label {
        color : inherit !important;
    }
    `;

    var x = document.createElement('STYLE');
    var t = document.createTextNode(style);
    x.appendChild(t);
    document.head.appendChild(x);

  

    // CodeMirror, copyright (c) by Marijn Haverbeke and others
    // Distributed under an MIT license: https://codemirror.net/LICENSE

    (function (mod) {
        if (typeof exports == `object` && typeof module == `object`) // CommonJS
            mod(require(`../../lib/codemirror`));
        else if (typeof define == `function` && define.amd) // AMD
            define([`../../lib/codemirror`], mod);
        else // Plain browser env
            mod(CodeMirror);
    })(function (CodeMirror) {
        var Pos = CodeMirror.Pos;

        function getToken(line, start, end, regexp) {
            while (start && regexp.test(line.charAt(start - 1))) --start
            while (end < line.length && regexp.test(line.charAt(end))) ++end
            return { 'keyword': line.slice(start, end), 'start': start, 'end': end }
        }
        function nxHint(editor, options) {

            var cursor = editor.getCursor(), line = editor.getLine(cursor.line)
            var start = cursor.ch, end = cursor.ch
            var token = getToken(line, start, end, /\w/);

            var type = null;
            if (line.charAt(token.start - 1) == '.')
                if (line.charAt(token.start - 2) == `'`)
                    var type = getToken(line, token.start - 3, token.start - 2, /[^']/).keyword;
                else
                    if (/^[a-zA-Z]/.test(line.charAt(token.start - 2))) {
                        var type = getToken(line, token.start - 3, token.start - 2, /\w/).keyword;
                    }
            return {
                list: getCompletions(type, token.keyword, options),
                from: Pos(cursor.line, token.start),
                to: Pos(cursor.line, token.end)
            };
        };
        CodeMirror.registerHelper(`hint`, `nx`, nxHint);

        var nxFunctions = [{ 'function': 'dialog()' }, { 'function': 'abs()' }, { 'function': 'number()' }, { 'function': 'asin()' }, { 'function': 'atan()' }, { 'function': 'atan2()' }, { 'function': 'ceil()' }, { 'function': 'round()' }, { 'function': 'floor()' }, { 'function': 'sqrt()' }, { 'function': 'sqr()' }, { 'function': 'sign()' }, { 'function': 'sin()' }, { 'function': 'cos()' }, { 'function': 'tan()' }, { 'function': 'random()' }, { 'function': 'pow()' }, { 'function': 'exp()' }, { 'function': 'log()' }, { 'function': 'odd()' }, { 'function': 'even()' }, { 'function': 'ln()' }, { 'function': 'acos()' }, { 'function': 'text()' }, { 'function': 'substr()' }, { 'function': 'length()' }, { 'function': 'trim()' }, { 'function': 'lower()' }, { 'function': 'upper()' }, { 'function': 'lpad()' }, { 'function': 'rpad()' }, { 'function': 'contains()' }, { 'function': 'index()' }, { 'function': 'replace()' }, { 'function': 'capitalize()' }, { 'function': 'chosen()' }, { 'function': 'createTextFile()' }, { 'function': 'now()' }, { 'function': 'today()' }, { 'function': 'date()' }, { 'function': 'day()' }, { 'function': 'weekday()' }, { 'function': 'weekdayName()' }, { 'function': 'weekdayIndex()' }, { 'function': 'week()' }, { 'function': 'yearweek()' }, { 'function': 'month()' }, { 'function': 'year()' }, { 'function': 'yearquarter()' }, { 'function': 'yearmonth()' }, { 'function': 'age()' }, { 'function': 'format()' }, { 'function': 'days()' }, { 'function': 'workdays()' }, { 'function': 'start()' }, { 'function': 'endof()' }, { 'function': 'duration()' }, { 'function': 'time()' }, { 'function': 'datetime()' }, { 'function': 'timeinterval()' }, { 'function': 'appointment()' }, { 'function': 'createCalendarEvent()' }, { 'function': 'createCalendarReminder()' }, { 'function': 'sort()' }, { 'function': 'rsort()' }, { 'function': 'item(ARRAY)' }, { 'function': 'slice()' }, { 'function': 'sum()' }, { 'function': 'avg()' }, { 'function': 'first()' }, { 'function': 'last()' }, { 'function': 'min()' }, { 'function': 'max()' }, { 'function': 'cnt()' }, { 'function': 'concat()' }, { 'function': 'unique()' }, { 'function': 'range()' }, { 'function': 'split()' }, { 'function': 'splitx()' }, { 'function': 'select' }, { 'function': 'create' }, { 'function': 'delete' }, { 'function': 'duplicate()' }, { 'function': 'record()' }, { 'function': 'printRecord()' }, { 'function': 'openPrintLayout()' }, { 'function': 'openRecord()' }, { 'function': 'popupRecord()' }, { 'function': 'openFullscreen()' }, { 'function': 'closeFullscreen()' }, { 'function': 'openTable()' }, { 'function': 'closeRecord()' }, { 'function': 'closeAllRecords()' }, { 'function': 'file()' }, { 'function': 'files()' }, { 'function': 'importFile()' }, { 'function': 'printAndSaveRecord()' }, { 'function': 'if ... then' }, { 'function': 'switch ... case' }, { 'function': 'for ... from ... to' }, { 'function': 'while ... do' }, { 'function': 'icon()' }, { 'function': 'alert()' }, { 'function': 'sendEmail()' }, { 'function': 'barcodeScan()' }, { 'function': 'html()' }, { 'function': 'http()' }, { 'function': 'ninoxApp()' }, { 'function': 'openURL()' }, { 'function': 'urlEncode()' }, { 'function': 'urlDecode()' }, { 'function': 'raw()' }, { 'function': 'parseXML()' }, { 'function': 'formatXML()' }, { 'function': 'location()' }, { 'function': 'longitude()' }, { 'function': 'latitude()' }, { 'function': 'do as server' }, { 'function': 'user()' }, { 'function': 'users()' }, { 'function': 'userId()' }, { 'function': 'userName()' }, { 'function': 'userFirstName()' }, { 'function': 'userLastName()' }, { 'function': 'userFullName()' }, { 'function': 'userEmail()' }, { 'function': 'userHasRole()' }, { 'function': 'userRole()' }, { 'function': 'let' }, { 'function': 'var' }, { 'function': 'replacex()' }, { 'function': 'testx()' }, { 'function': 'extractx()' }, { 'function': 'styled()' }, { 'function': '_cd' }, { 'function': '_md' }, { 'function': 'printTable()' }, { 'function': 'function' }, { 'function': '_cu' }, { 'function': '_mu' }, { 'function': 'numbers()' }, { 'function': 'rgb()' }, { 'function': 'rgba()' }, { 'function': 'quarter()' }, { 'function': 'for ... in ... do' }, { 'function': 'monthName()' }, { 'function': 'monthIndex()' }, { 'function': 'order by' }, { 'function': 'color()' }, { 'function': 'null' }, { 'function': 'userRoles()' }, { 'function': 'item(JSON)' }, { 'function': 'join()' }, { 'function': '---String---' }, { 'function': 'databaseId()' }, { 'function': 'tableId()' }, { 'function': 'teamId()' }, { 'function': 'array()' }, { 'function': 'isAdminMode()' }, { 'function': 'isDatabaseLocked()' }, { 'function': 'isDatabaseProtected()' }, { 'function': 'phone()' }, { 'function': 'email()' }, { 'function': 'url()' }, { 'function': 'sleep()' }, { 'function': 'eval()' }, { 'function': 'clientLang()' }, { 'function': 'like' }, { 'function': 'debug()' }, { 'function': 'degrees()' }, { 'function': 'radians()' }, { 'function': 'userIsAdmin()' }, { 'function': 'debugValueInfo()' }, { 'function': 'timestamp()' }, { 'function': 'string()' }, { 'function': 'substring()' }, { 'function': '%' }, { 'function': 'urlOf()' }, { 'function': 'cached()' }, { 'function': 'invalidate()' }, { 'function': 'weekdayNameAllLang()' }, { 'function': 'parseJSON()' }, { 'function': 'formatJSON()' }, { 'function': 'fileMetadata()' }, { 'function': 'waitForSync()' }, { 'function': 'sendCommand(string,string)' }, { 'function': 'querryConnection(string,string)' }, { 'function': 'getVault(string)' }, { 'function': 'shareFile()' }, { 'function': 'shareView()' }, { 'function': 'unshareFile()' }, { 'function': 'unshareAllViews()' }, { 'function': 'unshareView()' }, { 'function': 'correctedDate()' }, { 'function': 'typeof()' }, { 'function': 'get()' }, { 'function': 'do as transaction' }, { 'function': 'createTempFile()' }, { 'function': 'appendTempFile()' }];

        function getHumanName(caption) {
            if (/[^a-zA-Z]/.test(caption)) return `'${caption}'`;
            else return caption;
        }

        function getCompletions(currentType, keywords, options) {

            function getElement(text, type, displayText, base, iconClassName, colorName) {
                return {
                    displayText: displayText ? displayText : text,
                    text: text,
                    type: type,
                    classeName: 'fn-tools-field',
                    base: base,
                    colorName: colorName ? colorName : 'light-grey',
                    iconClassName: iconClassName,
                    render: function (elt, data, cur) {
                        var icon = document.createElement('div');
                        icon.className = 'fn-tools-field-icon i-' + this.colorName + ' ' + (this.iconClassName ? this.iconClassName : '');
                        elt.appendChild(icon);

                        var label = document.createElement('div');
                        label.className = 'fn-tools-field-label CodeMirror-hint-label'
                        label.innerText = cur.displayText;
                        elt.appendChild(label);
                    }
                }
            }
            var found = [];
            if (!currentType) {
                nxFunctions.forEach(fn => {
                    if (fn.function.search(RegExp(keywords, 'i')) >= 0) {
                        found.push(getElement(fn.function, 'nxFunction', null, 'apply', 'i-32-24 i-field-formula', 'blue'))
                    }
                })

                Object.keys(database.schema.globalScope).forEach(f => {
                    var func = database.schema.globalScope[f];
                    
                    if (func.id.search(RegExp(keywords, 'i')) >= 0) {
                        strFunc = `${getHumanName(func.id)}(${func.params.map(p => { return getHumanName(p.caption) }).join(',')})`
                        found.push(getElement(strFunc, 'globalFunction', null, 'fn', 'i-32-24 i-field-formula', 'red'));
                    }
                });
            }
            if (currentType) {
               
                var type = database.schema.findType(currentType);
                if (type) {
                    Object.keys(type.fields).forEach(f => {
                        var field = type.fields[f];
                        if (field.caption.search(RegExp(keywords, 'i')) >= 0)
                            found.push(getElement(getHumanName(field.caption), 'field', null, field.base, 'i-32-24 i-field-' + field.base, 'grey'))
                    });
                }
            }
            else {
                Object.keys(database.schema.types).forEach(t => {
                    var type = database.schema.types[t];
                    if (type.caption.search(RegExp(keywords, 'i')) >= 0)
                        found.push(getElement(getHumanName(type.caption), 'type', null, null, 'nav-item-icon ' + (type.icon ? 'ic ic-' + type.icon : 'i-32-24 ic i-setting-table')))

                    Object.keys(type.fields).forEach(f => {
                        var field = type.fields[f];
                        if (field.caption.search(RegExp(keywords, 'i')) >= 0)
                            found.push(getElement(getHumanName(field.caption), 'field', null, field.base, 'i-32-24 i-field-' + field.base))
                    });

                });
            }

            found.sort((a, b) => {
                var ra = a.displayText.search(RegExp(keywords, 'i'));
                var rb = b.displayText.search(RegExp(keywords, 'i'));
                var rac = a.displayText.search(RegExp(keywords, ''));
                var rbc = b.displayText.search(RegExp(keywords, ''));
                if (ra == 0 && rb == 0)
                    if (rac == 0 && rbc == 0)
                        return 0
                    else
                        if (ra == 0)
                            return -1;
                        else
                            return 1;
                else
                    if (ra == 0)
                        return -1;
                    else
                        if (rb == 0)
                            return 1;
                        else return 0;
            })
            return found;
        }

    });

    CodeMirror.defaults.extraKeys = { 'Ctrl-Space': 'autocomplete' };
</script>
